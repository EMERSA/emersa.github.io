<script>//var object5 = "I'm going to fuck you silly";</script>
		<!-- Import maps polyfill -->
		<!-- Remove this when import maps will be widely supported -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.2/dat.gui.js"></script>  
		<script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>

		<script type="importmap">
			{
				"imports": {
					"three": "/build/three.module.js",
					"three/addons/": "/jsm/"
				}
			}
		</script>

        

		<script type="module">

			import * as THREE from 'three';

			import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
			import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
			import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
            import { TrackballControls } from 'three/addons/controls/TrackballControls.js';

			let camera, scene, renderer, analyser, analyser2, bufferLength, frequencyData;
            var mesh18;

			init();
			render();



			function init() {
                
                const fftSize = 128;
 // Buttons startButton and resetButton
 var startButton = document.getElementById( 'startButtonId' );
 var resetButton = document.getElementById( 'resetButtonId' );
 var playtrack = document.getElementById( 'playtrack' );


				const container = document.createElement( 'div' );
                container.setAttribute("id", "Div1");
				document.body.appendChild( container );

				camera = new THREE.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 0.25, 20 );
				camera.position.set( 0, 0,0 );
                
                var light = new THREE.AmbientLight(0xf6e86d);

				scene = new THREE.Scene();
                scene.add(light);
				console.log(scene);

						// model
                        const listener = new THREE.AudioListener();
						const loader = new GLTFLoader().setPath( '/assets/glb/' );
						loader.load( 'a1a.glb', function ( gltf ) {
                            gltf.scene.scale.set( 1, 1, 1 );
						//	scene.add( gltf.scene );
                            const mesh = gltf.scene.children[ 0 ];
                            const mesh1 = gltf.scene.children[ 1 ];
                            const mesh2 = gltf.scene.children[ 2 ];
                            const mesh3 = gltf.scene.children[ 3 ];
                            const mesh4 = gltf.scene.children[ 4 ];
                            const mesh5 = gltf.scene.children[ 5 ];
                            const mesh6 = gltf.scene.children[ 6 ];
                            const mesh7 = gltf.scene.children[ 7 ];
                            const mesh8 = gltf.scene.children[ 8 ];
                            const mesh9 = gltf.scene.children[ 9 ];
                            const mesh10 = gltf.scene.children[ 10 ];
                            const mesh11 = gltf.scene.children[ 11 ];
                            const mesh12 = gltf.scene.children[ 12 ];
                            const mesh13 = gltf.scene.children[ 13 ];
                            const mesh14 = gltf.scene.children[ 14 ];
                            const mesh15 = gltf.scene.children[ 15 ];
                            const mesh16 = gltf.scene.children[ 16 ];
                            const mesh17 = gltf.scene.children[ 17 ];
                            const mesh18 = gltf.scene.children[ 18 ];
                            const mesh19 = gltf.scene.children[ 19 ];
                            const mesh20 = gltf.scene.children[ 20 ];
                            const mesh21 = gltf.scene.children[ 21 ];
                            const mesh22 = gltf.scene.children[ 22 ];
                            const mesh23 = gltf.scene.children[ 23 ];
                            const mesh24 = gltf.scene.children[ 24 ];
                            const mesh25 = gltf.scene.children[ 25 ];
                            const mesh26 = gltf.scene.children[ 26 ];
                            const mesh27 = gltf.scene.children[ 27 ];
                            const mesh28 = gltf.scene.children[ 28 ];
                      scene.add( mesh, mesh1, mesh2, mesh3, mesh4, mesh5, mesh6, mesh7, mesh8, mesh9, mesh10, mesh11, mesh12, mesh13, mesh14, mesh15, mesh16, mesh17, mesh18, mesh19, mesh20, mesh21, mesh22, mesh23, mesh24, mesh25, mesh26, mesh27, mesh28);
                      mesh.scale.set(0.010783,0.010783,0.010783);
                     console.log( mesh, mesh1, mesh2, mesh3, mesh4, mesh5, mesh6, mesh7, mesh8, mesh9, mesh10, mesh11, mesh12, mesh13, mesh14, mesh15, mesh16, mesh17, mesh18, mesh19, mesh20, mesh21, mesh22, mesh23, mesh24, mesh25, mesh26, mesh27, mesh28);
                      const head = mesh;
                       var     mixer = new THREE.AnimationMixer( head );
                       var gui = new dat.GUI();
                      

//actions = {};





				// Set up dat.GUI to control targets
			

                gui.add(camera.position, 'x', -500,500).step(5);
    gui.add(camera.position, 'y', -500,500).step(5);
    gui.add(camera.position, 'z', 1000,5000).step(5);
    

                const control = {
					OpenMouth: 0
				};
			
gui.add(control, 'OpenMouth', 0,1).step(0.01).listen().onChange(function(value){
// const head = mesh.getObjectByName( 'Will' );
mesh18.morphTargetInfluences[0] = value;
});

startButton.onclick = function StartAnimation() {
setTimeout(function() {mesh18.morphTargetInfluences[0] = 1;}, 500);
setTimeout(function() {mesh18.morphTargetInfluences[0] = 0;}, 1000);

          
         

    
   
    /*
if (initAnim) {
  initAnim = false;
  runAnim = true;
  theta = 0;
}
// Start and Pause 
if (runAnim) { 
  startButton.innerHTML = 'Pause';
  runAnim = false;
  isPlay = true;
  animate();
  } 
  else {
        startButton.innerHTML = 'Restart';
        runAnim = true;
        isPlay = false;
  }
  */
}



                       gui.close();
							render();

						} );

					

                renderer = new THREE.WebGLRenderer( { antialias: true , alpha: true } );
                renderer.setClearColor( 0x000000, 0 );
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.toneMapping = THREE.ACESFilmicToneMapping;
				renderer.toneMappingExposure = 1;
				renderer.outputEncoding = THREE.sRGBEncoding;
				container.appendChild( renderer.domElement );

				const controls = new OrbitControls( camera, renderer.domElement );
				controls.addEventListener( 'change', render ); // use if there is no animation loop
				controls.minDistance = 2;
				controls.maxDistance = 10;
				controls.target.set( 0, 0, - 0.2 );
				controls.update();
                const controls2 = new TrackballControls(camera, renderer.domElement);
                controls2.rotateSpeed = 1.0;
                controls2.zoomSpeed = 4;
                controls2.panSpeed = 0.8;
                controls2.noZoom = false;
                controls2.noPan = false;
                controls2.staticMoving = true;
                controls2.dynamicDampingFactor = 0.3
                controls2.update();
                // create an AudioListener and add it to the camera
                

           
                playtrack.onclick = function playtrack1() {
                         // create a global audio source
                const image2 = `<img src="/media/d1.jpg" class="rounded-circle user_img_msg">`;
                const image1 = `{% include image2.html %}`;
                let xhr = new XMLHttpRequest();
                var userMessage = document.querySelector("#userInput").value;
                let userHtml = '<div class="d-flex justify-content-end mb-4">'+'<div class="msg_cotainer_send">'+userMessage+'</div>'+image1+'</div>'
                document.querySelector('#body').innerHTML+= userHtml;
                xhr.open(`GET`, `https://chatapi-vd80.onrender.com/test123/${userMessage}`);
                xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhr.send(`messageValue=${userMessage}`);
                xhr.onload = function () {
                var obj = JSON.parse(this.responseText);
                console.log(JSON.stringify(obj.traits));
                var objlength = JSON.stringify(obj.traits);
                var obj1q = JSON.stringify(this.responseText);
                if (objlength.length < 3) {
   var objecttext = "I'm sorry, but I didn't understand the question. Please try again";
   console.log(objecttext+'dfgdfgdfgdfgdgdgdgdgf'); 
}else { var objecttext = obj.traits.text[0].value};
                let botHtml = '<div class="d-flex justify-content-start mb-4">'+'<div class="img_cont_msg">'+image2+'</div>'+'<div class="msg_cotainer">'+objecttext+'</div>'+'</div>'
                document.querySelector('#body').innerHTML+= botHtml;
                const listener = new THREE.AudioListener();
                camera.add( listener );
                const sound = new THREE.Audio( listener );
                const audioLoader = new THREE.AudioLoader();
audioLoader.load( `https://nodetts.onrender.com/?text=${objecttext}`, function( buffer ) {
    //sound.start(0);
	sound.setBuffer( buffer );
	sound.setLoop( false );
	sound.setVolume( 0.5 );
	sound.play();
 
const ctx = new AudioContext();
const audioSrc = '/media/download2.mp3';
//const analyser = ctx.createAnalyser();

const analyser1a = new THREE.AudioAnalyser( sound, 32 );

const data = analyser1a.getAverageFrequency();
//audioSrc.connect(analyser);
//analyser.connect(ctx.destination);

analyser1a.fftSize = 256;
const bufferLength = analyser1a.frequencyBinCount;
const frequencyData = new Uint8Array(bufferLength);

initAudio();

setInterval(() => {
    console.log(analyser1a.data);
    console.log(data);
 //  analyser1a.getByteFrequencyData(frequencyData);
   console.log(frequencyData);
}, 1000);
    

    function draw23(){
        for (let i = 0; i < bufferLength; i++) {
console.log('i eat shit kjkjkjk');

requestAnimationFrame(draw23);
  
}
console.log('i eat shit kjkjkjk');
console.log( bufferLength);
    }
    return draw23();
}

); 


//const analyser1 = new THREE.AudioAnalyser( sound, 32 );

analyser = new THREE.AudioAnalyser( sound, fftSize );

// get the average frequency of the sound
const data5 = analyser.getAverageFrequency();
// get the average frequency of the sound
//console.log( analyser1.data);


                };
              
                };
				window.addEventListener( 'resize', onWindowResize );

			}

			function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

				render();

			}

			//
     
            function draw22() {
    console.log('i eat shit');
    //console.log(analyser2.data);
    analyser2.getFrequencyData(frequencyData);
  let frequencyWidth = Math.ceil(canvas.width / bufferLength);
  for (let i = 0; i < bufferLength; i++) {
console.log('i eat shit');

  }
 
  requestAnimationFrame(draw22);
}

			function render() {
                requestAnimationFrame(render);
  
				renderer.render( scene, camera );
                //analyser.getFrequencyData();
                

			}

		</script>